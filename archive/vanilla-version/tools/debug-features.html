<!DOCTYPE html>
<html>
<head>
    <title>Debug Features - Platform Roadmap</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
        }
        h1, h2 {
            color: #60a5fa;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #2563eb;
        }
        button.danger {
            background: #ef4444;
        }
        button.danger:hover {
            background: #dc2626;
        }
        pre {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            border: 1px solid #3a3a3a;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
        }
        .status.success {
            background: #10b98133;
            border: 1px solid #10b981;
        }
        .status.error {
            background: #ef444433;
            border: 1px solid #ef4444;
        }
        .status.warning {
            background: #f59e0b33;
            border: 1px solid #f59e0b;
        }
    </style>
</head>
<body>
    <h1>üîß Debug & Fix Features</h1>
    <p>Use this tool to diagnose and fix missing features issues.</p>

    <div class="section">
        <h2>1. Check Current State</h2>
        <button onclick="checkLocalStorage()">Check localStorage</button>
        <button onclick="checkSupabase()">Check Supabase</button>
        <button onclick="checkWorkspaces()">Check Workspaces</button>
        <div id="checkResult"></div>
    </div>

    <div class="section">
        <h2>2. Fix Missing Features</h2>
        <p>If features exist but aren't visible, this will assign them to the current workspace:</p>
        <button onclick="fixOrphanedFeatures()">Fix Orphaned Features</button>
        <button onclick="createDefaultWorkspace()">Create Default Workspace</button>
        <div id="fixResult"></div>
    </div>

    <div class="section">
        <h2>3. Force Reload</h2>
        <p>Reload all data from Supabase:</p>
        <button onclick="forceReload()">Force Reload from Cloud</button>
        <div id="reloadResult"></div>
    </div>

    <div class="section">
        <h2>4. Emergency Recovery</h2>
        <p style="color: #f59e0b;">‚ö†Ô∏è Use if features are completely missing:</p>
        <button class="danger" onclick="showAllFeatures()">Show ALL Features (Bypass Workspace Filter)</button>
        <div id="emergencyResult"></div>
    </div>

    <script>
        async function checkLocalStorage() {
            const result = document.getElementById('checkResult');
            result.innerHTML = '<div class="status warning">Checking localStorage...</div>';

            const features = JSON.parse(localStorage.getItem('roadmapFeatures') || '[]');
            const workspaces = JSON.parse(localStorage.getItem('roadmapWorkspaces') || '[]');
            const currentWorkspaceId = localStorage.getItem('currentWorkspaceId');

            const featuresWithWorkspace = features.filter(f => f.workspaceId);
            const featuresWithoutWorkspace = features.filter(f => !f.workspaceId);

            let html = `<div class="status ${features.length > 0 ? 'success' : 'error'}">`;
            html += `<h3>localStorage Status:</h3>`;
            html += `<p><strong>Total Features:</strong> ${features.length}</p>`;
            html += `<p><strong>Features with workspace_id:</strong> ${featuresWithWorkspace.length}</p>`;
            html += `<p><strong>Features without workspace_id:</strong> ${featuresWithoutWorkspace.length}</p>`;
            html += `<p><strong>Total Workspaces:</strong> ${workspaces.length}</p>`;
            html += `<p><strong>Current Workspace ID:</strong> ${currentWorkspaceId || 'NONE'}</p>`;

            if (workspaces.length > 0) {
                html += `<h4>Workspaces:</h4>`;
                workspaces.forEach(w => {
                    const count = features.filter(f => f.workspaceId === w.id).length;
                    html += `<p>‚Ä¢ ${w.name} (${w.id}): ${count} features</p>`;
                });
            }

            if (featuresWithoutWorkspace.length > 0) {
                html += `<h4 style="color: #f59e0b;">‚ö†Ô∏è Orphaned Features (need fixing):</h4>`;
                featuresWithoutWorkspace.slice(0, 5).forEach(f => {
                    html += `<p>‚Ä¢ ${f.name} (${f.id})</p>`;
                });
                if (featuresWithoutWorkspace.length > 5) {
                    html += `<p>... and ${featuresWithoutWorkspace.length - 5} more</p>`;
                }
            }

            html += `</div>`;
            result.innerHTML = html;
        }

        async function checkSupabase() {
            const result = document.getElementById('checkResult');
            result.innerHTML = '<div class="status warning">Checking Supabase... (this may take a moment)</div>';

            try {
                // This assumes the main app's supabase client is available
                if (typeof supabase === 'undefined') {
                    result.innerHTML = '<div class="status error">Supabase client not available. Please open this from the main app.</div>';
                    return;
                }

                const { data: features, error } = await supabase
                    .from('features')
                    .select('id, name, workspace_id')
                    .eq('user_id', 'default');

                if (error) throw error;

                const withWorkspace = features.filter(f => f.workspace_id);
                const withoutWorkspace = features.filter(f => !f.workspace_id);

                let html = `<div class="status ${features.length > 0 ? 'success' : 'error'}">`;
                html += `<h3>Supabase Status:</h3>`;
                html += `<p><strong>Total Features:</strong> ${features.length}</p>`;
                html += `<p><strong>Features with workspace_id:</strong> ${withWorkspace.length}</p>`;
                html += `<p><strong>Features without workspace_id:</strong> ${withoutWorkspace.length}</p>`;

                if (withoutWorkspace.length > 0) {
                    html += `<h4 style="color: #ef4444;">‚ùå Problem Found:</h4>`;
                    html += `<p>${withoutWorkspace.length} features in database don't have workspace_id assigned!</p>`;
                    html += `<p>Run "Fix Orphaned Features" to assign them to a workspace.</p>`;
                }

                html += `</div>`;
                result.innerHTML = html;
            } catch (error) {
                result.innerHTML = `<div class="status error">Error: ${error.message}</div>`;
            }
        }

        async function checkWorkspaces() {
            const result = document.getElementById('checkResult');
            result.innerHTML = '<div class="status warning">Checking workspaces...</div>';

            const workspaces = JSON.parse(localStorage.getItem('roadmapWorkspaces') || '[]');
            const currentWorkspaceId = localStorage.getItem('currentWorkspaceId');

            let html = `<div class="status ${workspaces.length > 0 ? 'success' : 'error'}">`;
            html += `<h3>Workspace Configuration:</h3>`;

            if (workspaces.length === 0) {
                html += `<p style="color: #ef4444;"><strong>‚ùå NO WORKSPACES FOUND!</strong></p>`;
                html += `<p>This is why you can't see features. Click "Create Default Workspace" to fix this.</p>`;
            } else {
                html += `<p><strong>Total Workspaces:</strong> ${workspaces.length}</p>`;
                html += `<p><strong>Current Workspace:</strong> ${currentWorkspaceId || 'NONE SET'}</p>`;

                if (!currentWorkspaceId) {
                    html += `<p style="color: #f59e0b;">‚ö†Ô∏è No workspace selected! Set to: ${workspaces[0].id}</p>`;
                    localStorage.setItem('currentWorkspaceId', workspaces[0].id);
                    html += `<p style="color: #10b981;">‚úì Auto-selected first workspace</p>`;
                }

                html += `<h4>Your Workspaces:</h4>`;
                workspaces.forEach(w => {
                    const isCurrent = w.id === currentWorkspaceId;
                    html += `<p ${isCurrent ? 'style="color: #10b981; font-weight: bold;"' : ''}>`;
                    html += `${isCurrent ? '‚ûú ' : '  '}${w.icon} ${w.name} (ID: ${w.id})`;
                    html += `</p>`;
                });
            }

            html += `</div>`;
            result.innerHTML = html;
        }

        async function fixOrphanedFeatures() {
            const result = document.getElementById('fixResult');
            result.innerHTML = '<div class="status warning">Fixing orphaned features...</div>';

            const features = JSON.parse(localStorage.getItem('roadmapFeatures') || '[]');
            const workspaces = JSON.parse(localStorage.getItem('roadmapWorkspaces') || '[]');
            let currentWorkspaceId = localStorage.getItem('currentWorkspaceId');

            // Create workspace if none exist
            if (workspaces.length === 0) {
                await createDefaultWorkspace();
                return;
            }

            // Set current workspace if not set
            if (!currentWorkspaceId) {
                currentWorkspaceId = workspaces[0].id;
                localStorage.setItem('currentWorkspaceId', currentWorkspaceId);
            }

            // Fix features without workspace_id
            const orphaned = features.filter(f => !f.workspaceId);

            if (orphaned.length === 0) {
                result.innerHTML = '<div class="status success">‚úì No orphaned features found. All features have workspace assignments.</div>';
                return;
            }

            orphaned.forEach(f => {
                f.workspaceId = currentWorkspaceId;
            });

            localStorage.setItem('roadmapFeatures', JSON.stringify(features));

            // Sync to Supabase if available
            if (typeof app !== 'undefined' && app.saveData) {
                await app.saveData();
            }

            result.innerHTML = `<div class="status success">‚úì Fixed ${orphaned.length} orphaned features! Assigned to workspace: ${workspaces.find(w => w.id === currentWorkspaceId)?.name}. <strong>Reload the page to see them.</strong></div>`;
        }

        async function createDefaultWorkspace() {
            const result = document.getElementById('fixResult');
            result.innerHTML = '<div class="status warning">Creating default workspace...</div>';

            const workspace = {
                id: Date.now().toString(),
                name: 'My Roadmap',
                description: 'Default workspace',
                color: '#3b82f6',
                icon: 'üìä',
                customInstructions: '',
                aiMemory: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            const workspaces = [workspace];
            localStorage.setItem('roadmapWorkspaces', JSON.stringify(workspaces));
            localStorage.setItem('currentWorkspaceId', workspace.id);

            // Assign all features to this workspace
            const features = JSON.parse(localStorage.getItem('roadmapFeatures') || '[]');
            features.forEach(f => {
                f.workspaceId = workspace.id;
            });
            localStorage.setItem('roadmapFeatures', JSON.stringify(features));

            // Sync to Supabase if available
            if (typeof supabase !== 'undefined') {
                try {
                    await supabase.from('workspaces').insert([{
                        id: workspace.id,
                        user_id: 'default',
                        name: workspace.name,
                        description: workspace.description,
                        color: workspace.color,
                        icon: workspace.icon,
                        created_at: workspace.createdAt,
                        updated_at: workspace.updatedAt
                    }]);

                    // Update features in Supabase
                    for (const f of features) {
                        await supabase
                            .from('features')
                            .update({ workspace_id: workspace.id })
                            .eq('id', f.id)
                            .eq('user_id', 'default');
                    }
                } catch (error) {
                    console.error('Supabase sync error:', error);
                }
            }

            result.innerHTML = `<div class="status success">‚úì Created default workspace "${workspace.name}" and assigned ${features.length} features! <strong>Reload the page to see them.</strong></div>`;
        }

        async function forceReload() {
            const result = document.getElementById('reloadResult');
            result.innerHTML = '<div class="status warning">Force reloading from Supabase...</div>';

            if (typeof app !== 'undefined' && app.loadData) {
                await app.loadData();
                await app.loadWorkspaces();
                app.renderTable();
                app.renderWorkspaceSelector();
                result.innerHTML = '<div class="status success">‚úì Data reloaded! Check the main app.</div>';
            } else {
                result.innerHTML = '<div class="status error">App not available. Please run this from the main application page.</div>';
            }
        }

        async function showAllFeatures() {
            const result = document.getElementById('emergencyResult');
            result.innerHTML = '<div class="status warning">Loading ALL features (bypassing workspace filter)...</div>';

            const features = JSON.parse(localStorage.getItem('roadmapFeatures') || '[]');

            let html = `<div class="status ${features.length > 0 ? 'success' : 'error'}">`;
            html += `<h3>All Features in localStorage:</h3>`;
            html += `<p><strong>Total:</strong> ${features.length}</p>`;

            if (features.length > 0) {
                html += `<h4>Features List:</h4>`;
                html += `<pre style="max-height: 400px; overflow-y: auto;">`;
                features.forEach((f, i) => {
                    html += `${i + 1}. ${f.name}\n`;
                    html += `   ID: ${f.id}\n`;
                    html += `   Workspace ID: ${f.workspaceId || 'NOT SET'}\n`;
                    html += `   Timeline Items: ${f.timelineItems?.length || 0}\n`;
                    html += `\n`;
                });
                html += `</pre>`;

                html += `<p><strong>Solution:</strong> Run "Fix Orphaned Features" to assign these to a workspace.</p>`;
            } else {
                html += `<p style="color: #ef4444;">No features found in localStorage!</p>`;
                html += `<p>Try importing your backup file again.</p>`;
            }

            html += `</div>`;
            result.innerHTML = html;
        }

        // Auto-check on load
        window.addEventListener('load', () => {
            checkLocalStorage();
        });
    </script>
</body>
</html>
